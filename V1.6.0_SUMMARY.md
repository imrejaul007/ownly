# OWNLY Sandbox v1.6.0 - Development Summary

**Status**: ✅ Models Created - Ready for Controller Implementation
**Version**: 1.6.0
**Codename**: Integration & Automation
**Target Release**: Q4 2025

---

## 🎯 Overview

Version 1.6.0 transforms the OWNLY Sandbox Platform into a connected ecosystem with powerful integrations and automation capabilities. This release focuses on four major integration systems:

1. **Payment Integration** - Stripe payment processing with multiple payment methods
2. **Webhook System** - Real-time event notifications to external systems
3. **Email Integration** - Automated email campaigns with template system
4. **Workflow Automation** - Customizable workflow engine for process automation

---

## ✅ Completed Work

### Database Models (7 New Models)

#### 1. PaymentMethod Model
- **Purpose**: Store user payment methods (cards, bank accounts)
- **Fields**:
  - Type (card, bank_account, ach, wire)
  - Provider details (Stripe ID, customer ID)
  - Masked card/bank info (last 4, exp date, brand)
  - Billing address, verification status
  - Default payment method flag
- **Relationships**: User hasMany PaymentMethod

#### 2. Transaction Model (Enhanced)
- **Purpose**: Track all payment transactions
- **Note**: Model already existed, will be enhanced with payment_method_id
- **Fields**:
  - User, payment method, investment, payout references
  - Type, direction, status
  - Amount, currency, fees, net amount
  - Provider transaction ID and status
  - Receipt URL, timestamps
- **Relationships**: User hasMany Transaction, PaymentMethod hasMany Transaction

#### 3. Webhook Model
- **Purpose**: Store webhook configurations
- **Fields**:
  - User ID, name, URL
  - Subscribed events array
  - Status (active, inactive, paused)
  - Secret for payload signing
  - Retry configuration (max attempts, delays)
  - Statistics (deliveries, successes, failures)
- **Relationships**: User hasMany Webhook, Webhook hasMany WebhookDelivery

#### 4. WebhookDelivery Model
- **Purpose**: Track each webhook delivery attempt
- **Fields**:
  - Webhook ID, event type, event ID
  - Payload (JSONB)
  - Status, attempt count
  - Request/response details
  - Error tracking
  - Next retry timestamp
- **Relationships**: Webhook hasMany WebhookDelivery

#### 5. EmailTemplate Model
- **Purpose**: Store reusable email templates
- **Fields**:
  - Name, display name, category
  - Subject, HTML/text body, preview text
  - Available variables array
  - Sample data for testing
  - Sender configuration (from name/email, reply-to)
  - Status, version, send count
- **Relationships**: EmailTemplate hasMany EmailLog

#### 6. EmailLog Model
- **Purpose**: Track all sent emails
- **Fields**:
  - Template ID, user ID, recipient details
  - Email content (subject, HTML, text)
  - Provider details (SendGrid/Mailgun)
  - Status (pending, sent, delivered, opened, clicked, bounced)
  - Tracking (open count, click count, timestamps)
  - Error and bounce details
  - Template data used
- **Relationships**: User hasMany EmailLog, EmailTemplate hasMany EmailLog

#### 7. Workflow Model
- **Purpose**: Define automated workflows
- **Fields**:
  - Name, description
  - Trigger type (event, schedule, manual, webhook, condition)
  - Trigger configuration
  - Steps array (JSONB with actions and conditions)
  - Status, timeout, retry settings
  - Variables, execution statistics
- **Relationships**: Workflow hasMany WorkflowExecution

#### 8. WorkflowExecution Model
- **Purpose**: Track workflow runs
- **Fields**:
  - Workflow ID, trigger user ID
  - Status, trigger data, context
  - Current step, completed steps, step results
  - Error tracking
  - Retry tracking
  - Performance metrics, logs
  - Output, timestamps
- **Relationships**: Workflow hasMany WorkflowExecution, User hasMany WorkflowExecution

### Model Integration
- ✅ Added 7 new models to `models/index.js`
- ✅ Relationships defined
- ✅ Exports updated
- **Total Models**: 19 → **26** (+7)

---

## 📋 Implementation Roadmap

### Phase 1: Backend Controllers & Routes

#### Payment Controller
**File**: `controllers/paymentController.js`

**Endpoints Needed**:
```javascript
// Payment Methods
GET    /api/payments/methods              // Get user's payment methods
POST   /api/payments/methods              // Add new payment method
GET    /api/payments/methods/:id          // Get payment method details
PATCH  /api/payments/methods/:id          // Update payment method
DELETE /api/payments/methods/:id          // Remove payment method
POST   /api/payments/methods/:id/verify   // Verify payment method
POST   /api/payments/methods/:id/set-default // Set as default

// Transactions
GET    /api/payments/transactions         // Get transaction history
GET    /api/payments/transactions/:id     // Get transaction details
POST   /api/payments/charge                // Create payment charge
POST   /api/payments/refund/:id           // Refund transaction

// Stripe Integration
POST   /api/payments/stripe/setup-intent  // Create Stripe setup intent
POST   /api/payments/stripe/payment-intent // Create payment intent
POST   /api/payments/stripe/webhook       // Stripe webhook endpoint
```

**Key Functions**:
- `getPaymentMethods` - List user's saved payment methods
- `addPaymentMethod` - Add card or bank account via Stripe
- `removePaymentMethod` - Delete payment method
- `createCharge` - Process a payment
- `createSetupIntent` - For adding payment methods (Stripe)
- `handleStripeWebhook` - Process Stripe events

**Stripe Integration**:
- Setup Stripe SDK
- Payment intents for charges
- Setup intents for adding payment methods
- Webhook signature verification
- Error handling for failed payments

---

#### Webhook Controller
**File**: `controllers/webhookController.js`

**Endpoints Needed**:
```javascript
GET    /api/webhooks                // Get user's webhooks
POST   /api/webhooks                // Create new webhook
GET    /api/webhooks/:id            // Get webhook details
PATCH  /api/webhooks/:id            // Update webhook
DELETE /api/webhooks/:id            // Delete webhook
POST   /api/webhooks/:id/test       // Test webhook delivery

// Delivery logs
GET    /api/webhooks/:id/deliveries // Get delivery history
GET    /api/webhooks/:id/deliveries/:deliveryId // Get delivery details
POST   /api/webhooks/:id/deliveries/:deliveryId/retry // Retry failed delivery

// Events
GET    /api/webhooks/events         // Get available event types
```

**Key Functions**:
- `createWebhook` - Register new webhook
- `updateWebhook` - Modify webhook configuration
- `deleteWebhook` - Remove webhook
- `triggerWebhook` - Send webhook (called by other parts of system)
- `retryDelivery` - Retry failed webhook delivery
- `getDeliveryLogs` - View webhook delivery history

**Webhook Triggering System**:
- Export `triggerWebhook(eventType, data)` function
- Call from other controllers when events occur
- Implement retry logic with exponential backoff
- Payload signing for security
- Async delivery to not block main requests

---

#### Email Controller
**File**: `controllers/emailController.js`

**Endpoints Needed**:
```javascript
// Templates
GET    /api/emails/templates        // Get email templates
POST   /api/emails/templates        // Create template
GET    /api/emails/templates/:id    // Get template details
PATCH  /api/emails/templates/:id    // Update template
DELETE /api/emails/templates/:id    // Delete template
POST   /api/emails/templates/:id/preview // Preview template

// Sending
POST   /api/emails/send              // Send email
POST   /api/emails/send-template     // Send using template

// Logs
GET    /api/emails/logs              // Get email logs
GET    /api/emails/logs/:id          // Get email log details
GET    /api/emails/stats             // Get email statistics

// Webhooks (from email provider)
POST   /api/emails/sendgrid/webhook  // SendGrid events
POST   /api/emails/mailgun/webhook   // Mailgun events
```

**Key Functions**:
- `createTemplate` - Create email template
- `sendEmail` - Send email directly
- `sendTemplatedEmail` - Send using template
- `renderTemplate` - Render template with variables
- `handleEmailEvent` - Process email provider webhooks (opens, clicks)
- `getEmailStats` - Analytics for email campaigns

**Email Provider Integration**:
- SendGrid or Mailgun integration
- Template rendering engine (Handlebars or Mustache)
- Variable substitution
- HTML/text versions
- Tracking pixel for opens
- Click tracking

---

#### Workflow Controller
**File**: `controllers/workflowController.js`

**Endpoints Needed**:
```javascript
// Workflows
GET    /api/workflows               // Get workflows
POST   /api/workflows               // Create workflow
GET    /api/workflows/:id           // Get workflow details
PATCH  /api/workflows/:id           // Update workflow
DELETE /api/workflows/:id           // Delete workflow
POST   /api/workflows/:id/activate  // Activate workflow
POST   /api/workflows/:id/pause     // Pause workflow

// Execution
POST   /api/workflows/:id/execute   // Manually trigger workflow
GET    /api/workflows/:id/executions // Get execution history
GET    /api/workflows/executions/:executionId // Get execution details
POST   /api/workflows/executions/:executionId/cancel // Cancel running execution

// Templates
GET    /api/workflows/templates     // Get workflow templates
POST   /api/workflows/from-template // Create from template
```

**Key Functions**:
- `createWorkflow` - Define new workflow
- `updateWorkflow` - Modify workflow steps
- `executeWorkflow` - Run workflow manually
- `processWorkflowExecution` - Execute workflow steps
- `handleWorkflowTrigger` - Triggered by events/schedules
- `cancelExecution` - Stop running workflow

**Workflow Engine**:
- Step-by-step execution engine
- Conditional logic support
- Action types: send_email, send_webhook, wait, condition, update_record
- Error handling and retries
- Parallel execution support (future)
- Workflow templates for common patterns

---

### Phase 2: Frontend Pages

#### Payment Settings Page
**File**: `app/settings/payments/page.tsx`

**Features**:
- List saved payment methods (cards, bank accounts)
- Add new payment method (Stripe Elements)
- Set default payment method
- Remove payment method
- View transaction history
- Payment method verification

**UI Components**:
- Payment method cards with masked details
- Add payment modal with Stripe Elements
- Transaction history table
- Payment status badges

---

#### Webhooks Management Page
**File**: `app/webhooks/page.tsx` or `app/settings/webhooks/page.tsx`

**Features**:
- List user's webhooks
- Create new webhook
- Edit webhook configuration
- Test webhook
- View delivery logs
- Retry failed deliveries
- Available events list

**UI Components**:
- Webhook cards with status
- Create/edit webhook modal
- Event selector (checkboxes)
- Delivery log timeline
- Test webhook button

---

#### Email Templates Page
**File**: `app/emails/page.tsx` or `app/settings/emails/page.tsx`

**Features**:
- List email templates
- Create new template
- Edit template (HTML editor)
- Preview template
- Template variables guide
- Send test email
- View email statistics

**UI Components**:
- Template cards
- HTML/visual editor
- Variable insertion helper
- Preview modal
- Email statistics dashboard

---

#### Workflows Page
**File**: `app/workflows/page.tsx`

**Features**:
- List workflows
- Create new workflow
- Visual workflow builder (drag-and-drop steps)
- Edit workflow configuration
- Activate/pause workflows
- View execution history
- Execution logs viewer

**UI Components**:
- Workflow cards with status
- Visual workflow builder (nodes and connections)
- Step configuration modals
- Execution timeline
- Execution logs viewer

---

### Phase 3: Frontend Integration

#### Update API Client
**File**: `lib/api.ts`

```typescript
// Payment APIs
export const paymentAPI = {
  getPaymentMethods: () => api.get('/payments/methods'),
  addPaymentMethod: (data: any) => api.post('/payments/methods', data),
  removePaymentMethod: (id: string) => api.delete(`/payments/methods/${id}`),
  setDefaultPaymentMethod: (id: string) => api.post(`/payments/methods/${id}/set-default`),
  getTransactions: (params?: any) => api.get('/payments/transactions', { params }),
  createCharge: (data: any) => api.post('/payments/charge', data),
  createSetupIntent: () => api.post('/payments/stripe/setup-intent'),
};

// Webhook APIs
export const webhookAPI = {
  getWebhooks: () => api.get('/webhooks'),
  createWebhook: (data: any) => api.post('/webhooks', data),
  getWebhookDetails: (id: string) => api.get(`/webhooks/${id}`),
  updateWebhook: (id: string, data: any) => api.patch(`/webhooks/${id}`, data),
  deleteWebhook: (id: string) => api.delete(`/webhooks/${id}`),
  testWebhook: (id: string) => api.post(`/webhooks/${id}/test`),
  getDeliveries: (id: string) => api.get(`/webhooks/${id}/deliveries`),
  retryDelivery: (webhookId: string, deliveryId: string) =>
    api.post(`/webhooks/${webhookId}/deliveries/${deliveryId}/retry`),
  getEventTypes: () => api.get('/webhooks/events'),
};

// Email APIs
export const emailAPI = {
  getTemplates: () => api.get('/emails/templates'),
  createTemplate: (data: any) => api.post('/emails/templates', data),
  updateTemplate: (id: string, data: any) => api.patch(`/emails/templates/${id}`, data),
  deleteTemplate: (id: string) => api.delete(`/emails/templates/${id}`),
  previewTemplate: (id: string, data: any) => api.post(`/emails/templates/${id}/preview`, data),
  sendEmail: (data: any) => api.post('/emails/send', data),
  sendTemplatedEmail: (data: any) => api.post('/emails/send-template', data),
  getEmailLogs: (params?: any) => api.get('/emails/logs', { params }),
  getEmailStats: () => api.get('/emails/stats'),
};

// Workflow APIs
export const workflowAPI = {
  getWorkflows: () => api.get('/workflows'),
  createWorkflow: (data: any) => api.post('/workflows', data),
  getWorkflowDetails: (id: string) => api.get(`/workflows/${id}`),
  updateWorkflow: (id: string, data: any) => api.patch(`/workflows/${id}`, data),
  deleteWorkflow: (id: string) => api.delete(`/workflows/${id}`),
  activateWorkflow: (id: string) => api.post(`/workflows/${id}/activate`),
  pauseWorkflow: (id: string) => api.post(`/workflows/${id}/pause`),
  executeWorkflow: (id: string, data?: any) => api.post(`/workflows/${id}/execute`, data),
  getExecutions: (id: string) => api.get(`/workflows/${id}/executions`),
  getExecutionDetails: (executionId: string) => api.get(`/workflows/executions/${executionId}`),
  getWorkflowTemplates: () => api.get('/workflows/templates'),
};
```

---

## 🎨 Webhook Event Types

Events that can trigger webhooks:

### Investment Events
- `investment.created` - New investment made
- `investment.updated` - Investment details changed
- `investment.completed` - Investment fully funded
- `investment.cancelled` - Investment cancelled

### Deal Events
- `deal.created` - New deal published
- `deal.updated` - Deal details changed
- `deal.funded` - Deal reached funding goal
- `deal.closed` - Deal closed

### Payout Events
- `payout.created` - New payout generated
- `payout.distributed` - Payout distributed to investors
- `payout.completed` - Payout completed
- `payout.failed` - Payout failed

### Document Events
- `document.uploaded` - New document added
- `document.signed` - Document signed
- `document.shared` - Document shared with user

### User Events
- `user.created` - New user registered
- `user.kyc_approved` - KYC verification approved
- `user.kyc_rejected` - KYC verification rejected

### Transaction Events
- `transaction.created` - New transaction
- `transaction.completed` - Transaction completed
- `transaction.failed` - Transaction failed

---

## 📊 Expected Outcomes

### Database
- **Total Models**: 26 (was 19, +7)
- **New Tables**: 7 (payment_methods, webhooks, webhook_deliveries, email_templates, email_logs, workflows, workflow_executions)
- **Total Relationships**: 40+

### API
- **New Endpoints**: ~50+
- **Total Endpoints**: ~180

### Frontend
- **New Pages**: 4-5 (payments, webhooks, emails, workflows)
- **Total Pages**: 26-27

---

## 🔄 Implementation Checklist

### Backend
- ✅ Create models (DONE)
- ⏳ Create payment controller (~12 endpoints)
- ⏳ Create webhook controller (~10 endpoints)
- ⏳ Create email controller (~12 endpoints)
- ⏳ Create workflow controller (~12 endpoints)
- ⏳ Create route files (4 files)
- ⏳ Update main routes index
- ⏳ Integrate Stripe SDK
- ⏳ Integrate SendGrid/Mailgun
- ⏳ Implement webhook delivery system
- ⏳ Implement workflow execution engine
- ⏳ Update version to 1.6.0

### Frontend
- ⏳ Create payment settings page
- ⏳ Create webhooks management page
- ⏳ Create email templates page
- ⏳ Create workflows page
- ⏳ Integrate Stripe Elements
- ⏳ Build visual workflow builder
- ⏳ Update API client

### Integration
- ⏳ Stripe account setup
- ⏳ SendGrid/Mailgun account setup
- ⏳ Webhook signature verification
- ⏳ Email template system
- ⏳ Workflow execution engine

### Testing
- ⏳ Test payment flows
- ⏳ Test webhook deliveries
- ⏳ Test email sending
- ⏳ Test workflow executions
- ⏳ Security testing

### Documentation
- ⏳ API documentation
- ⏳ Webhook event documentation
- ⏳ Email template guide
- ⏳ Workflow examples
- ⏳ Release notes

---

## 💡 Key Implementation Notes

### Stripe Integration

```javascript
import Stripe from 'stripe';
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

// Create payment intent
const paymentIntent = await stripe.paymentIntents.create({
  amount: amount * 100, // Convert to cents
  currency: 'usd',
  customer: user.stripe_customer_id,
  payment_method: paymentMethod.provider_payment_method_id,
  confirm: true,
});

// Create setup intent for adding payment method
const setupIntent = await stripe.setupIntents.create({
  customer: user.stripe_customer_id,
});
```

### Webhook Delivery

```javascript
// Trigger webhook
export const triggerWebhook = async (eventType, data) => {
  const webhooks = await Webhook.findAll({
    where: {
      status: 'active',
      events: { [Op.contains]: [eventType] },
    },
  });

  for (const webhook of webhooks) {
    await deliverWebhook(webhook, eventType, data);
  }
};

// Deliver with retry
const deliverWebhook = async (webhook, eventType, data) => {
  const delivery = await WebhookDelivery.create({
    webhook_id: webhook.id,
    event_type: eventType,
    payload: data,
    request_url: webhook.url,
  });

  try {
    const signature = generateSignature(data, webhook.secret);
    const response = await axios.post(webhook.url, data, {
      headers: {
        'X-Webhook-Signature': signature,
        'X-Event-Type': eventType,
      },
      timeout: webhook.timeout * 1000,
    });

    await delivery.update({
      status: 'sent',
      response_status_code: response.status,
      sent_at: new Date(),
    });
  } catch (error) {
    await delivery.update({
      status: 'failed',
      error_message: error.message,
      failed_at: new Date(),
    });

    // Schedule retry if attempts < max_attempts
    if (delivery.attempt_count < delivery.max_attempts) {
      scheduleRetry(delivery);
    }
  }
};
```

### Email Sending

```javascript
import sgMail from '@sendgrid/mail';
sgMail.setApiKey(process.env.SENDGRID_API_KEY);

export const sendTemplatedEmail = async (templateId, userId, variables) => {
  const template = await EmailTemplate.findByPk(templateId);
  const user = await User.findByPk(userId);

  // Render template
  const html = renderTemplate(template.html_body, variables);
  const subject = renderTemplate(template.subject, variables);

  // Send email
  const msg = {
    to: user.email,
    from: template.from_email || process.env.DEFAULT_FROM_EMAIL,
    subject,
    html,
  };

  const result = await sgMail.send(msg);

  // Log email
  await EmailLog.create({
    email_template_id: templateId,
    user_id: userId,
    to_email: user.email,
    subject,
    html_body: html,
    provider: 'sendgrid',
    provider_message_id: result[0].headers['x-message-id'],
    status: 'sent',
    sent_at: new Date(),
  });
};
```

### Workflow Execution

```javascript
export const executeWorkflow = async (workflowId, triggerData) => {
  const workflow = await Workflow.findByPk(workflowId);

  const execution = await WorkflowExecution.create({
    workflow_id: workflowId,
    trigger_data: triggerData,
    status: 'running',
    started_at: new Date(),
  });

  try {
    let currentStep = workflow.steps[0];
    const context = { ...triggerData };

    while (currentStep) {
      const result = await executeStep(currentStep, context, execution);

      if (result.nextStep) {
        currentStep = workflow.steps.find(s => s.id === result.nextStep);
      } else {
        break;
      }
    }

    await execution.update({
      status: 'completed',
      completed_at: new Date(),
    });
  } catch (error) {
    await execution.update({
      status: 'failed',
      error_message: error.message,
      failed_at: new Date(),
    });
  }
};

const executeStep = async (step, context, execution) => {
  switch (step.action) {
    case 'send_email':
      await sendTemplatedEmail(step.config.template_id, context.user_id, context);
      break;
    case 'send_webhook':
      await triggerWebhook(step.config.event_type, context);
      break;
    case 'wait':
      await new Promise(resolve => setTimeout(resolve, step.config.seconds * 1000));
      break;
    // Add more actions as needed
  }

  return { nextStep: step.next_step_id };
};
```

---

## 🎯 Success Criteria

- ✅ All 7 models created and integrated
- [ ] Payment processing works with Stripe
- [ ] Webhooks deliver reliably with retries
- [ ] Emails send successfully using templates
- [ ] Workflows execute correctly
- [ ] All frontend pages functional
- [ ] Third-party integrations tested
- [ ] Security measures implemented
- [ ] Documentation complete

---

## 📦 Third-Party Services Required

### Payment Processing
- **Stripe Account** (Recommended)
  - Payment intents
  - Setup intents
  - Customer management
  - Webhook events

### Email Service
- **SendGrid** (Recommended) or **Mailgun**
  - Transactional email API
  - Email templates
  - Click/open tracking
  - Webhook events

### Optional
- **Plaid** - For bank account connections
- **Twilio** - For SMS notifications in workflows

---

## 🔐 Security Considerations

### Payment Security
- PCI compliance (Stripe handles card data)
- Never store raw card numbers
- Secure payment method tokens
- Transaction encryption

### Webhook Security
- HMAC signature verification
- Rate limiting
- IP whitelisting (optional)
- Payload size limits

### Email Security
- SPF/DKIM/DMARC configuration
- Unsubscribe links
- Spam prevention
- Content sanitization

### Workflow Security
- Execution timeouts
- Resource limits
- Input validation
- Privilege escalation prevention

---

**Version**: 1.6.0 (In Progress)
**Models Status**: ✅ Complete (7 new models)
**Controllers Status**: ⏳ Pending
**Frontend Status**: ⏳ Pending
**Estimated Completion**: 2-3 weeks of development

This is a major release that will require significant integration work with third-party services. Consider implementing in phases:
- **Phase 1**: Payment Integration
- **Phase 2**: Webhook System
- **Phase 3**: Email Integration
- **Phase 4**: Workflow Automation
