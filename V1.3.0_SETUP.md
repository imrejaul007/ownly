# V1.3.0 Setup Guide

Quick setup guide for upgrading to or installing OWNLY Sandbox v1.3.0.

---

## 🚀 Quick Upgrade from v1.2.0

### 1. Install New Dependencies
```bash
cd backend
npm install
# This will install node-cron and other dependencies
```

### 2. Sync Database (Development)
```bash
# Start backend - it will auto-create new tables
npm run dev
```

### 3. Verify Installation
```bash
# Check health endpoint
curl http://localhost:5000/api/health
# Should show version: "1.3.0"
```

### 4. Start Frontend
```bash
cd ../frontend
npm run dev
```

### 5. Test New Features
- Visit http://localhost:3000/secondary-market
- Visit http://localhost:3000/agent-dashboard
- Visit http://localhost:3000/payout-schedules

---

## 📋 New Database Tables

The following tables will be created automatically:

1. **secondary_market_listings**
   - Stores investment listings for sale
   - Tracks offers and transactions

2. **payout_schedules**
   - Stores recurring payout configurations
   - Tracks next payout dates and status

---

## 🔧 Configuration

### Cron Job Configuration

The payout scheduler runs automatically when the backend starts. To customize:

**Edit**: `backend/src/cron/payoutScheduler.js`

```javascript
// Default: Runs daily at 9:00 AM
cron.schedule('0 9 * * *', async () => {
  // ... processing logic
});

// Examples of other schedules:
// '0 * * * *'      - Every hour
// '*/30 * * * *'   - Every 30 minutes
// '0 0 * * 0'      - Every Sunday at midnight
// '0 12 * * 1-5'   - Weekdays at noon
```

### Environment Variables (Optional)

No new environment variables required for v1.3.0, but you can add:

```bash
# .env
CRON_ENABLED=true              # Enable/disable cron jobs
CRON_SCHEDULE="0 9 * * *"      # Customize schedule
SECONDARY_MARKET_FEE=0.025     # 2.5% transaction fee (future use)
```

---

## 🧪 Testing the New Features

### 1. Test Secondary Market

```bash
# Create test data
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "investor1@example.com", "password": "password123"}'

# Get token and create listing
# (Use Postman or frontend UI for easier testing)
```

**Or use Frontend**:
1. Login as `investor1@example.com`
2. Go to Portfolio
3. Visit `/secondary-market`
4. Create a listing
5. Login as different user to make offer

### 2. Test Agent Dashboard

```bash
# Find an agent user from seed data
# Default: Agent users have role 'agent'
```

**Frontend Test**:
1. Login with agent credentials
2. Visit `/agent-dashboard`
3. View metrics and referrals

### 3. Test Payout Schedules

**Frontend Test**:
1. Login as admin
2. Visit `/payout-schedules`
3. Create new schedule:
   - Select an SPV
   - Set frequency to "monthly"
   - Set amount
   - Enable auto-distribute
   - Set start date to today

4. Test manual processing:
   - Click "Process Due Payouts"
   - Check console logs

**Test Cron Job**:
```bash
# Method 1: Wait until 9:00 AM next day
# Method 2: Modify cron schedule to run every minute for testing

# Edit backend/src/cron/payoutScheduler.js
cron.schedule('* * * * *', async () => {  // Every minute
  // ... processing
});

# Restart backend and watch logs
```

---

## 📊 Sample API Requests

### Secondary Market

**Create Listing**:
```bash
POST /api/secondary-market/listings
Content-Type: application/json
Authorization: Bearer <token>

{
  "investmentId": "uuid-of-investment",
  "sharesForSale": 100,
  "pricePerShare": 52.50,
  "expiresInDays": 30
}
```

**Make Offer**:
```bash
POST /api/secondary-market/listings/:listingId/offer
Content-Type: application/json
Authorization: Bearer <token>

{
  "offerPrice": 5000.00
}
```

**Accept Offer**:
```bash
POST /api/secondary-market/listings/:listingId/respond
Content-Type: application/json
Authorization: Bearer <token>

{
  "action": "accept"
}
```

### Payout Schedules

**Create Schedule**:
```bash
POST /api/payout-schedules
Content-Type: application/json
Authorization: Bearer <admin-token>

{
  "spvId": "uuid-of-spv",
  "scheduleName": "Monthly Dividend",
  "frequency": "monthly",
  "amountPerPeriod": 10000.00,
  "startDate": "2025-02-01",
  "autoDistribute": true
}
```

**Get Upcoming Payouts**:
```bash
GET /api/payout-schedules/upcoming?days=30
Authorization: Bearer <token>
```

### Agent Dashboard

**Get Dashboard**:
```bash
GET /api/agents/dashboard
Authorization: Bearer <agent-token>
```

**Get Leaderboard**:
```bash
GET /api/agents/leaderboard?sortBy=volume&limit=10
Authorization: Bearer <token>
```

---

## 🗂️ File Structure (New Files Only)

```
ownly/
├── backend/
│   ├── src/
│   │   ├── models/
│   │   │   ├── SecondaryMarketListing.js    ✨ NEW
│   │   │   └── PayoutSchedule.js            ✨ NEW
│   │   ├── controllers/
│   │   │   ├── secondaryMarketController.js ✨ NEW
│   │   │   ├── payoutScheduleController.js  ✨ NEW
│   │   │   └── agentController.js           ✨ NEW
│   │   ├── routes/
│   │   │   ├── secondaryMarket.js           ✨ NEW
│   │   │   ├── payoutSchedule.js            ✨ NEW
│   │   │   └── agent.js                     ✨ NEW
│   │   └── cron/
│   │       └── payoutScheduler.js           ✨ NEW
│   └── package.json                         📝 MODIFIED
│
└── frontend/
    ├── app/
    │   ├── secondary-market/
    │   │   └── page.tsx                     ✨ NEW
    │   ├── agent-dashboard/
    │   │   └── page.tsx                     ✨ NEW
    │   └── payout-schedules/
    │       └── page.tsx                     ✨ NEW
    └── lib/
        └── api.ts                           📝 MODIFIED
```

---

## 🔍 Troubleshooting

### Issue: Cron job not running

**Solution**:
```bash
# Check server logs for:
[CRON] Payout scheduler started - runs daily at 9:00 AM

# If not present, verify:
1. server.js imports startPayoutScheduler
2. startPayoutScheduler() is called after server starts
3. node-cron is installed: npm list node-cron
```

### Issue: Database tables not created

**Solution**:
```bash
# Option 1: Delete and recreate database
dropdb ownly_sandbox
createdb ownly_sandbox
npm run db:seed

# Option 2: Manual sync
# In server.js, ensure:
await syncDatabase({ alter: true });
```

### Issue: Secondary market transaction fails

**Check**:
1. Seller owns the investment
2. Buyer has sufficient wallet balance
3. Investment is not already listed
4. Shares available >= shares being listed

### Issue: Payout schedule not processing

**Check**:
1. Schedule status is 'active'
2. next_payout_date is in the past
3. SPV has sufficient operating_balance
4. Cron job is running

---

## 📚 Additional Resources

- **Full Release Notes**: [V1.3.0_RELEASE_NOTES.md](./V1.3.0_RELEASE_NOTES.md)
- **Main README**: [README.md](./README.md)
- **Quick Start**: [QUICKSTART.md](./QUICKSTART.md)
- **Setup Guide**: [SETUP.md](./SETUP.md)

---

## ✅ Post-Installation Checklist

- [ ] Backend dependencies installed (`npm install`)
- [ ] Database tables created (check pgAdmin or `\dt` in psql)
- [ ] Backend running on port 5000
- [ ] Frontend running on port 3000
- [ ] Health check shows version 1.3.0
- [ ] Cron job log message appears in console
- [ ] Can access `/secondary-market` page
- [ ] Can access `/agent-dashboard` page
- [ ] Can access `/payout-schedules` page
- [ ] All three features tested with sample data

---

**Questions?** Check the main documentation or create an issue.

**v1.3.0** | Built with Claude Code
