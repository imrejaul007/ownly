# OWNLY Sandbox v1.3.0 Release Notes

**Release Date**: January 2025
**Version**: 1.3.0
**Codename**: Secondary Market & Automation

---

## üéâ Overview

Version 1.3.0 introduces three major feature sets that significantly enhance the OWNLY Sandbox platform:

1. **Secondary Market** - Enable investors to buy and sell their investment shares
2. **Enhanced Agent Dashboard** - Comprehensive agent analytics and performance tracking
3. **Automated Payout Scheduling** - Set recurring payout schedules with cron automation

---

## ‚ú® New Features

### üîÑ 1. Secondary Market

A complete marketplace for buying and selling investment shares on the secondary market.

#### Backend Components
- **New Model**: `SecondaryMarketListing` with support for listings, offers, and transactions
- **Controller**: `secondaryMarketController.js` with 7 API endpoints
- **Routes**: `/api/secondary-market/*`

#### API Endpoints
- `GET /api/secondary-market/listings` - Browse active listings
- `GET /api/secondary-market/my-listings` - View your listings
- `POST /api/secondary-market/listings` - Create new listing
- `GET /api/secondary-market/listings/:id` - Get listing details
- `POST /api/secondary-market/listings/:id/offer` - Make an offer
- `POST /api/secondary-market/listings/:id/respond` - Accept/reject offer
- `POST /api/secondary-market/listings/:id/cancel` - Cancel listing

#### Features
- List partial or full investment shares for sale
- Set custom price per share
- Make counter-offers on listings
- Accept/reject offers as seller
- Automatic transaction processing:
  - Transfer shares between investors
  - Process payments via wallets
  - Create new investment records for buyers
  - Update seller's remaining shares
- Transaction history tracking
- Listing expiration support

#### Frontend
- **New Page**: `/secondary-market`
- Two tabs: Browse Listings, My Listings
- Modal-based offer system
- Real-time status updates
- Listing management (pause, cancel)

---

### üë• 2. Enhanced Agent Dashboard

Comprehensive analytics and performance tracking for agents.

#### Backend Components
- **Controller**: `agentController.js` with advanced metrics calculation
- **Routes**: `/api/agents/*`

#### API Endpoints
- `GET /api/agents/dashboard` - Complete agent dashboard data
- `GET /api/agents/leaderboard` - Agent leaderboard with rankings
- `GET /api/agents/referrals/:id` - Detailed referral information
- `GET /api/agents/commissions` - Commission history

#### Metrics Tracked
- Total referrals and active referrals
- Conversion rate (referrals who invested)
- Total investment volume from referrals
- Commission earned, paid, and pending
- Monthly performance (last 12 months):
  - Referral count
  - Investment count
  - Total volume
- Deal type performance breakdown
- Top 10 referred investors by volume
- Recent activity (last 30 days)

#### Frontend
- **New Page**: `/agent-dashboard`
- Three tabs: Overview, Referrals, Commissions
- Visual monthly performance chart
- Deal type performance cards
- Top investors table
- Referral code display
- Real-time activity metrics

---

### ‚è∞ 3. Automated Payout Scheduling

Schedule recurring payouts with automatic distribution.

#### Backend Components
- **New Model**: `PayoutSchedule` with frequency and automation support
- **Controller**: `payoutScheduleController.js` with schedule management
- **Cron Job**: `cron/payoutScheduler.js` - Runs daily at 9:00 AM
- **Routes**: `/api/payout-schedules/*`

#### API Endpoints
- `GET /api/payout-schedules` - List all schedules
- `GET /api/payout-schedules/:id` - Get schedule details
- `POST /api/payout-schedules` - Create new schedule
- `PATCH /api/payout-schedules/:id` - Update schedule
- `POST /api/payout-schedules/:id/toggle` - Pause/resume schedule
- `DELETE /api/payout-schedules/:id` - Cancel schedule
- `POST /api/payout-schedules/process/due` - Process due payouts (cron)
- `GET /api/payout-schedules/upcoming` - Get upcoming payouts

#### Schedule Configuration
- **Frequencies**: Monthly, Quarterly, Semi-Annual, Annual, One-Time
- **Amount Types**:
  - Fixed amount per period
  - Percentage of revenue
- **Automation Options**:
  - Auto-distribute when generated
  - Manual approval required
- **Scheduling**:
  - Start date
  - End date (optional)
  - Next payout date tracking

#### Cron Job Features
- Runs daily at 9:00 AM
- Processes all due schedules automatically
- Checks SPV balance before processing
- Generates payouts and distributes if auto-enabled
- Updates next payout date based on frequency
- Handles schedule completion and expiration
- Error handling and logging

#### Frontend
- **New Page**: `/payout-schedules`
- Two tabs: All Schedules, Upcoming (30 Days)
- Create schedule modal with configuration
- Schedule management (pause, resume, cancel)
- Manual trigger for processing due payouts
- Upcoming payout forecast

---

## üîß Technical Improvements

### Database
- Added 2 new models (total: 13 models)
- New relationships:
  - `Investment` ‚Üî `SecondaryMarketListing`
  - `SPV` ‚Üî `PayoutSchedule`
  - `User` ‚Üî `SecondaryMarketListing` (as seller/buyer)

### Backend
- Added `node-cron` dependency for scheduled tasks
- Transaction-safe secondary market operations
- Enhanced error handling for complex workflows
- Cron job integration in server startup

### Frontend
- 3 new pages: `/secondary-market`, `/agent-dashboard`, `/payout-schedules`
- Enhanced API client with 20+ new endpoints
- Modal-based UI patterns for complex forms
- Real-time status updates

---

## üìä API Summary

### v1.3.0 New Endpoints: 20

**Secondary Market**: 7 endpoints
**Agent Dashboard**: 4 endpoints
**Payout Scheduling**: 9 endpoints

**Total API Endpoints**: 60+ across all versions

---

## üóÉÔ∏è Database Models

### New Models in v1.3.0

#### SecondaryMarketListing
```javascript
{
  investment_id: UUID,
  seller_id: UUID,
  buyer_id: UUID (nullable),
  shares_for_sale: INTEGER,
  price_per_share: DECIMAL,
  total_price: DECIMAL,
  status: ENUM ['active', 'pending_acceptance', 'sold', 'cancelled', 'expired'],
  offer_price: DECIMAL (nullable),
  listing_expires_at: DATE,
  sold_at: DATE,
  metadata: JSONB
}
```

#### PayoutSchedule
```javascript
{
  spv_id: UUID,
  schedule_name: STRING,
  frequency: ENUM ['monthly', 'quarterly', 'semi_annual', 'annual', 'one_time'],
  amount_per_period: DECIMAL,
  percentage_of_revenue: DECIMAL (nullable),
  start_date: DATE,
  end_date: DATE (nullable),
  next_payout_date: DATE,
  last_payout_date: DATE,
  status: ENUM ['active', 'paused', 'completed', 'cancelled'],
  auto_distribute: BOOLEAN,
  metadata: JSONB
}
```

---

## üöÄ Getting Started with v1.3.0

### 1. Install Dependencies
```bash
cd backend
npm install  # Installs node-cron and other dependencies
```

### 2. Run Database Migration
```bash
npm run db:migrate
```

### 3. Start Backend
```bash
npm run dev
# Cron job will start automatically and run daily at 9:00 AM
```

### 4. Start Frontend
```bash
cd ../frontend
npm run dev
```

### 5. Try New Features

**Secondary Market**:
1. Go to Portfolio page
2. Click "List for Sale" on any investment (or visit `/secondary-market`)
3. Create a listing with your desired price
4. Browse active listings and make offers
5. Accept/reject offers as a seller

**Agent Dashboard**:
1. Login as an agent user
2. Visit `/agent-dashboard`
3. View comprehensive analytics and metrics
4. Track referrals and commissions
5. See monthly performance trends

**Payout Scheduling**:
1. Login as admin/SPV admin
2. Visit `/payout-schedules`
3. Create a new recurring schedule
4. Set frequency, amount, and automation options
5. View upcoming payouts
6. Manual trigger: "Process Due Payouts" button

---

## üìà Impact & Benefits

### For Investors
- **Liquidity**: Sell investments before exit via secondary market
- **Flexibility**: Set your own prices and negotiate offers
- **Transparency**: Track all transactions and listing history

### For Agents
- **Analytics**: Deep insights into referral performance
- **Motivation**: Leaderboard and commission tracking
- **Optimization**: Understand which deal types convert best

### For Admins
- **Automation**: Set and forget recurring payouts
- **Efficiency**: Cron job handles processing automatically
- **Control**: Pause, resume, or cancel schedules anytime
- **Forecasting**: See upcoming payouts 30 days ahead

---

## üîÆ Future Enhancements

Potential additions for future versions:

1. **Secondary Market**:
   - Bidding system for multiple offers
   - Market price suggestions based on deal performance
   - Transaction fees and platform commission

2. **Agent Dashboard**:
   - Custom date range filtering
   - Export agent reports to PDF
   - Real-time commission payout requests

3. **Payout Scheduling**:
   - Email notifications before payouts
   - Conditional schedules based on SPV performance
   - Integration with external calendars

---

## üêõ Known Limitations

- Secondary market listings do not yet support partial offer acceptance
- Payout schedules cannot be edited after creation (must cancel and recreate)
- Agent commission calculations are simulated (metadata-based)
- Cron job runs only when backend server is running (consider external scheduler for production)

---

## üìù Migration Guide

### From v1.2.0 to v1.3.0

**Database**:
- New tables will be created automatically on first run (if using `syncDatabase`)
- For production, run migrations manually

**Frontend**:
- No breaking changes to existing pages
- New routes available: `/secondary-market`, `/agent-dashboard`, `/payout-schedules`

**Backend**:
- New dependency: `node-cron` (run `npm install`)
- Cron job starts automatically with server
- New API routes under `/api/secondary-market`, `/api/agents`, `/api/payout-schedules`

---

## üë®‚Äçüíª Developer Notes

### Testing Secondary Market
```bash
# 1. Create an investment as User A
# 2. List it for sale
# 3. Login as User B
# 4. Make an offer
# 5. Login back as User A
# 6. Accept the offer
# 7. Check both wallets and investments updated correctly
```

### Testing Payout Schedules
```bash
# 1. Create a schedule with start_date = today
# 2. Set next_payout_date to past date for testing
# 3. Call POST /api/payout-schedules/process/due
# 4. Verify payout created and schedule updated
```

### Cron Job Testing
```bash
# Manual trigger via API (admin only)
POST /api/payout-schedules/process/due
```

---

## üì¶ Files Changed/Added

### Backend (11 files)
**New Files**:
- `models/SecondaryMarketListing.js`
- `models/PayoutSchedule.js`
- `controllers/secondaryMarketController.js`
- `controllers/payoutScheduleController.js`
- `controllers/agentController.js`
- `routes/secondaryMarket.js`
- `routes/payoutSchedule.js`
- `routes/agent.js`
- `cron/payoutScheduler.js`

**Modified Files**:
- `models/index.js` - Added new models and relationships
- `routes/index.js` - Added new routes, updated version to 1.3.0
- `server.js` - Added cron job startup
- `package.json` - Added node-cron dependency

### Frontend (4 files)
**New Files**:
- `app/secondary-market/page.tsx`
- `app/agent-dashboard/page.tsx`
- `app/payout-schedules/page.tsx`

**Modified Files**:
- `lib/api.ts` - Added secondaryMarketAPI, agentAPI, payoutScheduleAPI

**Documentation**:
- `README.md` - Updated to v1.3.0
- `V1.3.0_RELEASE_NOTES.md` - This file

---

## üéØ Version Summary

| Component | v1.0.0 | v1.1.0 | v1.2.0 | v1.3.0 |
|-----------|--------|--------|--------|--------|
| Database Models | 11 | 11 | 11 | **13** |
| API Endpoints | 25 | 40 | 55 | **60+** |
| Frontend Pages | 5 | 7 | 8 | **11** |
| Background Jobs | 0 | 0 | 0 | **1** |

---

## üôè Acknowledgments

Built with Claude Code for the OWNLY Sandbox Platform.

**Version**: 1.3.0
**Build Date**: January 2025
**Status**: ‚úÖ Production Ready (Sandbox)

---

**Need Help?** See [QUICKSTART.md](./QUICKSTART.md) or [SETUP.md](./SETUP.md)
